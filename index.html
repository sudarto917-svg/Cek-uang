<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mesin Hitung Compact</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>

    <style>
        /* Menggunakan dvh (Dynamic Viewport Height) agar pas di browser HP modern */
        body { 
            background-color: #0f172a; 
            color: white; 
            font-family: sans-serif; 
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Progress Ring Compact */
        .scan-bar-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 180px; height: 180px; /* Diperkecil agar muat */
            pointer-events: none;
        }
        
        .scan-progress {
            fill: none;
            stroke: #22c55e;
            stroke-width: 8;
            stroke-dasharray: 500; 
            stroke-dashoffset: 500;
            transition: stroke-dashoffset 0.1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .scan-bg {
            fill: none;
            stroke: rgba(255,255,255,0.1);
            stroke-width: 8;
        }

        .flash-effect { animation: flash 0.3s; }
        @keyframes flash {
            0% { background-color: rgba(34, 197, 94, 0.5); }
            100% { background-color: transparent; }
        }

        /* Agar tombol terasa responsif */
        .btn-press:active { transform: scale(0.96); }
    </style>
</head>
<body>

    <!-- 1. HEADER: TOTAL (Sangat Kompak) -->
    <div class="bg-slate-800 px-4 py-3 border-b border-slate-700 shrink-0 flex justify-between items-center z-20 shadow-md">
        <div>
            <div class="text-[10px] text-slate-400 uppercase font-bold">Total</div>
            <div class="flex items-baseline gap-1">
                <span class="text-sm text-slate-500">Rp</span>
                <h1 id="grand-total" class="text-2xl font-bold text-white">0</h1>
            </div>
        </div>
        <button onclick="resetTotal()" class="bg-red-500/10 text-red-400 p-2 rounded-lg active:bg-red-500/30 border border-red-500/20">
            <!-- Icon Sampah -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        </button>
    </div>

    <!-- 2. KAMERA (FIXED HEIGHT - Tidak Full Screen) -->
    <!-- h-60 sekitar 240px, cukup untuk uang tapi hemat tempat -->
    <div class="relative h-60 bg-black shrink-0 overflow-hidden border-b border-slate-700" id="camera-container">
        <video id="webcam" autoplay playsinline muted class="absolute w-full h-full object-cover opacity-80"></video>
        
        <!-- Visual Ring -->
        <div class="scan-bar-container">
            <svg width="180" height="180">
                <circle cx="90" cy="90" r="80" class="scan-bg" />
                <circle cx="90" cy="90" r="80" class="scan-progress" id="progress-ring" />
            </svg>
        </div>

        <!-- Label Deteksi -->
        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <div id="detect-label" class="mt-10 text-xl font-bold text-white drop-shadow-lg bg-black/50 px-3 py-1 rounded-full opacity-0 transition-opacity">---</div>
        </div>

        <!-- Loading -->
        <div id="loading" class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center z-50">
            <div class="w-8 h-8 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-2 text-xs text-green-400 font-mono">Loading AI...</p>
        </div>
    </div>

    <!-- 3. NAVIGASI TAB -->
    <div class="flex bg-slate-800 border-b border-slate-700 shrink-0 text-sm">
        <button onclick="setMode('scan')" id="btn-mode-scan" class="flex-1 py-3 text-center font-bold text-green-400 border-b-2 border-green-400 bg-slate-700/50">
            Mulai Hitung
        </button>
        <button onclick="setMode('train')" id="btn-mode-train" class="flex-1 py-3 text-center text-slate-400 hover:text-white">
            Ajari Dulu
        </button>
    </div>

    <!-- 4. AREA MENU / KONTROL (SCROLLABLE) -->
    <!-- Bagian ini mengisi sisa layar (flex-1) dan bisa discroll (overflow-y-auto) -->
    <div class="flex-1 overflow-y-auto bg-slate-900 relative p-4">
        
        <!-- A. TAMPILAN TRAINING (Default Hidden) -->
        <div id="panel-train" class="hidden space-y-3 pb-10">
            <div class="bg-blue-900/20 border border-blue-800 p-3 rounded text-xs text-blue-200 flex gap-2 items-start">
                <span>‚ÑπÔ∏è</span>
                <p>Tekan tombol kamera <strong>30-40 kali</strong> untuk setiap uang. Wajib latih "Meja Kosong" agar tidak error.</p>
            </div>
            <!-- Tombol akan digenerate di sini -->
            <div id="train-buttons" class="space-y-2"></div>
        </div>

        <!-- B. TAMPILAN SCAN (Default Visible) -->
        <div id="panel-scan" class="flex flex-col items-center justify-center h-full text-slate-500 space-y-4">
            <div class="text-center p-4 border-2 border-dashed border-slate-700 rounded-xl">
                <p class="text-sm mb-2">Status Scanner:</p>
                <div id="scanner-status" class="text-green-400 font-bold text-lg flex items-center gap-2 justify-center">
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    Standby (Siap)
                </div>
                <p class="text-xs mt-4 text-slate-600 max-w-[200px] mx-auto">Letakkan uang di depan kamera, tunggu lingkaran hijau penuh, lalu ganti uang berikutnya.</p>
            </div>
        </div>

    </div>

    <!-- AUDIO -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime); // Volume pelan
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }
    </script>

    <script>
        // --- CONFIG ---
        const moneyTypes = [
            { id: '100k', val: 100000, label: 'Rp 100.000', color: 'text-red-400', btnColor: 'bg-red-600' },
            { id: '50k',  val: 50000,  label: 'Rp 50.000',  color: 'text-blue-400', btnColor: 'bg-blue-600' },
            { id: '20k',  val: 20000,  label: 'Rp 20.000',  color: 'text-green-400', btnColor: 'bg-green-600' },
            { id: '10k',  val: 10000,  label: 'Rp 10.000',  color: 'text-purple-400', btnColor: 'bg-purple-600' },
            { id: '5k',   val: 5000,   label: 'Rp 5.000',   color: 'text-yellow-400', btnColor: 'bg-yellow-600' },
            { id: '2k',   val: 2000,   label: 'Rp 2.000',   color: 'text-gray-400', btnColor: 'bg-gray-600' },
            { id: 'bg',   val: 0,      label: 'Meja / Kosong', color: 'text-slate-500', btnColor: 'bg-slate-700' }
        ];

        let net, classifier, webcam;
        let totalAmount = 0;
        let trainCounts = {};
        let currentClass = null;
        let scanProgress = 0;
        let isScanningLocked = false; 
        const SCAN_SPEED = 8; 

        async function init() {
            // Render Tombol Training
            const btnContainer = document.getElementById('train-buttons');
            moneyTypes.forEach(m => {
                trainCounts[m.id] = 0;
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full ${m.color.replace('text-', 'bg-')}"></div>
                        <div>
                            <div class="font-bold text-sm text-slate-200">${m.label}</div>
                            <div class="text-[10px] text-slate-500" id="cnt-${m.id}">0 Data</div>
                        </div>
                    </div>
                    <button onmousedown="train('${m.id}')" onmouseup="endTrain(this)" ontouchstart="train('${m.id}')" ontouchend="endTrain(this)"
                        class="bg-slate-700 hover:bg-slate-600 text-white w-12 h-10 rounded-lg flex items-center justify-center btn-press border border-slate-600 shadow-sm active:bg-blue-600 transition-colors">
                        üì∑
                    </button>
                `;
                btnContainer.appendChild(div);
            });

            try {
                net = await mobilenet.load();
                classifier = knnClassifier.create();
                webcam = document.getElementById('webcam');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: 640, height: 480 }
                });
                webcam.srcObject = stream;
                
                document.getElementById('loading').classList.add('hidden');
                loop();
            } catch (e) {
                alert("Error Kamera: " + e.message);
            }
        }

        async function loop() {
            if (classifier.getNumClasses() > 0) {
                const activation = net.infer(webcam, 'conv_preds');
                const result = await classifier.predictClass(activation, 20);
                processResult(result);
            }
            requestAnimationFrame(loop);
        }

        function processResult(result) {
            const label = result.label;
            const conf = result.confidences[label];
            const ring = document.getElementById('progress-ring');
            const labelUi = document.getElementById('detect-label');
            const statusText = document.getElementById('scanner-status');

            // Threshold 0.7
            if (conf > 0.7) {
                if (label === 'bg') {
                    isScanningLocked = false;
                    scanProgress = 0;
                    ring.style.strokeDashoffset = 500; // Reset (500 = approx circumference)
                    labelUi.style.opacity = 0;
                    statusText.innerHTML = `<span class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span> Standby`;
                    return;
                }

                if (!isScanningLocked) {
                    statusText.innerHTML = `<span class="text-yellow-400">Mendeteksi...</span>`;
                    
                    if (label === currentClass) {
                        scanProgress += SCAN_SPEED;
                    } else {
                        currentClass = label;
                        scanProgress = 0;
                    }

                    // Update Visual
                    // 500 is dasharray
                    const offset = 500 - (500 * (scanProgress / 100));
                    ring.style.strokeDashoffset = offset;
                    
                    const mData = moneyTypes.find(m => m.id === label);
                    labelUi.innerText = mData.label;
                    labelUi.className = `mt-10 text-xl font-bold bg-black/60 px-4 py-1 rounded-full transition-opacity ${mData.color}`;
                    labelUi.style.opacity = 1;

                    if (scanProgress >= 100) {
                        addMoney(label);
                        isScanningLocked = true;
                        statusText.innerHTML = `<span class="text-blue-400">‚úî Terhitung! Tarik Uang.</span>`;
                    }
                }
            } else {
                scanProgress = Math.max(0, scanProgress - 5);
            }
        }

        function addMoney(id) {
            const item = moneyTypes.find(m => m.id === id);
            totalAmount += item.val;
            document.getElementById('grand-total').innerText = totalAmount.toLocaleString('id-ID');
            
            playBeep();
            
            const camContainer = document.getElementById('camera-container');
            camContainer.classList.add('flash-effect');
            setTimeout(() => camContainer.classList.remove('flash-effect'), 300);

            const ring = document.getElementById('progress-ring');
            ring.style.stroke = "#60a5fa"; // Biru saat sukses
            setTimeout(() => { 
                ring.style.strokeDashoffset = 500; 
                ring.style.stroke = "#22c55e"; // Balik hijau
            }, 200);
        }

        function train(id) {
            const activation = net.infer(webcam, 'conv_preds');
            classifier.addExample(activation, id);
            trainCounts[id]++;
            document.getElementById(`cnt-${id}`).innerText = `${trainCounts[id]} Data`;
        }
        function endTrain(btn) {}

        function resetTotal() {
            if(confirm("Reset semua ke 0?")) {
                totalAmount = 0;
                document.getElementById('grand-total').innerText = "0";
                scanProgress = 0;
                currentClass = null;
                isScanningLocked = false;
                document.getElementById('progress-ring').style.strokeDashoffset = 500;
                document.getElementById('detect-label').style.opacity = 0;
            }
        }

        function setMode(mode) {
            const pTrain = document.getElementById('panel-train');
            const pScan = document.getElementById('panel-scan');
            const bTrain = document.getElementById('btn-mode-train');
            const bScan = document.getElementById('btn-mode-scan');

            if (mode === 'train') {
                pTrain.classList.remove('hidden');
                pScan.classList.add('hidden');
                bTrain.className = "flex-1 py-3 text-center font-bold text-green-400 border-b-2 border-green-400 bg-slate-700/50";
                bScan.className = "flex-1 py-3 text-center text-slate-400 hover:text-white";
            } else {
                pTrain.classList.add('hidden');
                pScan.classList.remove('hidden');
                bScan.className = "flex-1 py-3 text-center font-bold text-green-400 border-b-2 border-green-400 bg-slate-700/50";
                bTrain.className = "flex-1 py-3 text-center text-slate-400 hover:text-white";
            }
        }

        init();
    </script>
</body>
</html>


